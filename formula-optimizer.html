<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Profit Formula Optimizer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #555;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-add {
            background: #667eea;
            margin-top: 10px;
        }

        .results-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .formula-result {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }

        .formula-result.best {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .formula-result.worst {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .formula-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .formula-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 13px;
            color: #666;
        }

        .test-case {
            background: #edf2f7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-case-info {
            font-size: 13px;
            color: #555;
        }

        .test-case-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-error {
            background: #fed7d7;
            color: #742a2a;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .code-block {
            background: #1a202c;
            color: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            margin-top: 15px;
        }

        .keyword { color: #fc8181; }
        .function { color: #90cdf4; }
        .number { color: #f6ad55; }
        .comment { color: #68d391; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Target Profit Formula Optimizer</h1>
            <p class="subtitle">Reverse-engineer Lovely Profit's formula by testing multiple approaches</p>
        </div>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="card">
                <h2>üìä Add Test Case</h2>
                <div class="input-group">
                    <label>Initial Capital ($)</label>
                    <input type="number" id="capital" value="10000" step="100">
                </div>
                <div class="input-group">
                    <label>Total Trades</label>
                    <input type="number" id="totalTrades" value="10" min="1">
                </div>
                <div class="input-group">
                    <label>Accuracy/Win Rate (%)</label>
                    <input type="number" id="accuracy" value="70" min="0" max="100">
                </div>
                <div class="input-group">
                    <label>Risk-Reward Ratio (1:X)</label>
                    <input type="number" id="rrRatio" value="3" step="0.1" min="0.1">
                </div>
                <div class="input-group">
                    <label>Expected Target Profit from Lovely Profit ($)</label>
                    <input type="number" id="expectedProfit" value="" step="0.01" placeholder="Enter Lovely Profit's result">
                </div>
                <button class="btn btn-add" onclick="addTestCase()">‚ûï Add Test Case</button>
            </div>

            <!-- Test Cases List -->
            <div class="card">
                <h2>üìã Test Cases</h2>
                <div id="testCasesList">
                    <p style="color: #999; text-align: center; padding: 20px;">No test cases yet. Add one to get started!</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card full-width">
            <h2>üß™ Formula Comparison Results</h2>
            <button class="btn btn-secondary" onclick="runComparison()">‚ñ∂Ô∏è Run Comparison</button>

            <div class="summary-grid" id="summary" style="display: none;">
                <div class="metric">
                    <div class="metric-value" id="avgErrorOld">--</div>
                    <div class="metric-label">Old Formula Avg Error</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avgErrorNew">--</div>
                    <div class="metric-label">New Formula Avg Error</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="avgErrorHybrid">--</div>
                    <div class="metric-label">Hybrid Formula Avg Error</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="bestFormula">--</div>
                    <div class="metric-label">Best Overall</div>
                </div>
            </div>

            <div id="resultsContainer"></div>
        </div>

        <!-- Generated Code Section -->
        <div class="card full-width" id="generatedCode" style="display: none;">
            <h2>üíª Optimized Formula Code</h2>
            <p style="color: #666; margin-bottom: 15px;">Copy this code into your application:</p>
            <div class="code-block" id="codeOutput"></div>
        </div>
    </div>

    <script>
        let testCases = [];

        // Load from localStorage
        if (localStorage.getItem('testCases')) {
            testCases = JSON.parse(localStorage.getItem('testCases'));
            updateTestCasesList();
        }

        function addTestCase() {
            const capital = parseFloat(document.getElementById('capital').value);
            const totalTrades = parseInt(document.getElementById('totalTrades').value);
            const accuracy = parseFloat(document.getElementById('accuracy').value);
            const rrRatio = parseFloat(document.getElementById('rrRatio').value);
            const expectedProfit = parseFloat(document.getElementById('expectedProfit').value);

            if (!expectedProfit || isNaN(expectedProfit)) {
                alert('Please enter the expected profit from Lovely Profit!');
                return;
            }

            testCases.push({
                capital,
                totalTrades,
                accuracy,
                riskRewardRatio: rrRatio,
                expected: expectedProfit
            });

            localStorage.setItem('testCases', JSON.stringify(testCases));
            updateTestCasesList();

            // Clear expected profit field
            document.getElementById('expectedProfit').value = '';
        }

        function removeTestCase(index) {
            testCases.splice(index, 1);
            localStorage.setItem('testCases', JSON.stringify(testCases));
            updateTestCasesList();
        }

        function updateTestCasesList() {
            const list = document.getElementById('testCasesList');
            if (testCases.length === 0) {
                list.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No test cases yet. Add one to get started!</p>';
                return;
            }

            list.innerHTML = testCases.map((tc, i) => `
                <div class="test-case">
                    <div class="test-case-info">
                        <strong>Case ${i + 1}:</strong>
                        $${tc.capital} | ${tc.totalTrades} trades | ${tc.accuracy}% accuracy | 1:${tc.riskRewardRatio} RR
                        <br>
                        <span style="color: #667eea;">Expected: $${tc.expected.toFixed(2)}</span>
                    </div>
                    <div class="test-case-actions">
                        <button class="btn-small" onclick="removeTestCase(${i})">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        // Formula implementations
        function calculateOldFormula(tc) {
            const winRate = tc.accuracy / 100;
            const kelly = (winRate * tc.riskRewardRatio - (1 - winRate)) / tc.riskRewardRatio;
            if (kelly <= 0) return 0;

            const multiplier = tc.accuracy * 0.06;
            const perTradeReturn = tc.riskRewardRatio * tc.accuracy * 0.001 * multiplier;
            const finalBalance = tc.capital * Math.pow(1 + perTradeReturn, tc.totalTrades);
            return finalBalance - tc.capital;
        }

        function calculateNewFormula(tc) {
            const winRate = tc.accuracy / 100;
            const kelly = (winRate * tc.riskRewardRatio - (1 - winRate)) / tc.riskRewardRatio;
            if (kelly <= 0) return 0;

            const fractionalKelly = kelly * 0.25;
            const expectedValue = (winRate * tc.riskRewardRatio) - (1 - winRate);
            const rrFactor = Math.pow(tc.riskRewardRatio, 0.6);
            const accuracyFactor = Math.pow(winRate, 1.2);
            const perTradeReturn = fractionalKelly * expectedValue * rrFactor * accuracyFactor * 0.15;

            const finalBalance = tc.capital * Math.pow(1 + perTradeReturn, tc.totalTrades);
            return finalBalance - tc.capital;
        }

        function calculateHybridFormula(tc) {
            const winRate = tc.accuracy / 100;
            const kelly = (winRate * tc.riskRewardRatio - (1 - winRate)) / tc.riskRewardRatio;
            if (kelly <= 0) return 0;

            // Hybrid approach: Different scaling factors for different RR ranges
            let scalingFactor;
            let kellyFraction;

            if (tc.riskRewardRatio <= 2) {
                kellyFraction = 0.20;
                scalingFactor = 0.12;
            } else if (tc.riskRewardRatio <= 4) {
                kellyFraction = 0.25;
                scalingFactor = 0.18;
            } else {
                kellyFraction = 0.30;
                scalingFactor = 0.25;
            }

            const fractionalKelly = kelly * kellyFraction;
            const expectedValue = (winRate * tc.riskRewardRatio) - (1 - winRate);
            const accuracyBoost = Math.pow(winRate, 1.1);
            const rrBoost = Math.pow(tc.riskRewardRatio, 0.5);

            const perTradeReturn = fractionalKelly * expectedValue * accuracyBoost * rrBoost * scalingFactor;

            const finalBalance = tc.capital * Math.pow(1 + perTradeReturn, tc.totalTrades);
            return finalBalance - tc.capital;
        }

        function runComparison() {
            if (testCases.length === 0) {
                alert('Please add at least one test case!');
                return;
            }

            const results = testCases.map(tc => {
                const oldResult = calculateOldFormula(tc);
                const newResult = calculateNewFormula(tc);
                const hybridResult = calculateHybridFormula(tc);

                const oldError = Math.abs(oldResult - tc.expected) / tc.expected * 100;
                const newError = Math.abs(newResult - tc.expected) / tc.expected * 100;
                const hybridError = Math.abs(hybridResult - tc.expected) / tc.expected * 100;

                return {
                    tc,
                    results: {
                        old: { value: oldResult, error: oldError },
                        new: { value: newResult, error: newError },
                        hybrid: { value: hybridResult, error: hybridError }
                    }
                };
            });

            displayResults(results);
        }

        function displayResults(results) {
            const avgOldError = results.reduce((sum, r) => sum + r.results.old.error, 0) / results.length;
            const avgNewError = results.reduce((sum, r) => sum + r.results.new.error, 0) / results.length;
            const avgHybridError = results.reduce((sum, r) => sum + r.results.hybrid.error, 0) / results.length;

            document.getElementById('avgErrorOld').textContent = avgOldError.toFixed(2) + '%';
            document.getElementById('avgErrorNew').textContent = avgNewError.toFixed(2) + '%';
            document.getElementById('avgErrorHybrid').textContent = avgHybridError.toFixed(2) + '%';

            const minError = Math.min(avgOldError, avgNewError, avgHybridError);
            let bestFormula = 'Old';
            if (avgNewError === minError) bestFormula = 'New';
            if (avgHybridError === minError) bestFormula = 'Hybrid';

            document.getElementById('bestFormula').textContent = bestFormula;
            document.getElementById('summary').style.display = 'grid';

            const container = document.getElementById('resultsContainer');
            container.innerHTML = results.map((r, i) => {
                const minCaseError = Math.min(r.results.old.error, r.results.new.error, r.results.hybrid.error);

                return `
                    <div class="results-grid" style="margin-top: 20px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                        <h3 style="color: #333; margin-bottom: 15px;">
                            Test Case ${i + 1}:
                            <span style="font-size: 14px; font-weight: normal; color: #666;">
                                $${r.tc.capital} | ${r.tc.totalTrades} trades | ${r.tc.accuracy}% | 1:${r.tc.riskRewardRatio} RR
                                ‚Üí Expected: $${r.tc.expected.toFixed(2)}
                            </span>
                        </h3>

                        ${createFormulaResult('Old Formula', r.results.old, r.tc.expected, r.results.old.error === minCaseError)}
                        ${createFormulaResult('New Multi-Factor', r.results.new, r.tc.expected, r.results.new.error === minCaseError)}
                        ${createFormulaResult('Hybrid Conditional', r.results.hybrid, r.tc.expected, r.results.hybrid.error === minCaseError)}
                    </div>
                `;
            }).join('');

            // Generate optimized code
            generateCode(bestFormula);
        }

        function createFormulaResult(name, result, expected, isBest) {
            const badge = result.error < 10 ? 'badge-success' : result.error < 50 ? 'badge-warning' : 'badge-error';
            const badgeText = result.error < 10 ? 'Excellent' : result.error < 50 ? 'Good' : 'Needs Work';

            return `
                <div class="formula-result ${isBest ? 'best' : ''}">
                    <div class="formula-name">
                        ${name} ${isBest ? 'üèÜ' : ''}
                        <span class="badge ${badge}">${badgeText}</span>
                    </div>
                    <div class="formula-details">
                        <div>Result: <strong>$${result.value.toFixed(2)}</strong></div>
                        <div>Error: <strong>${result.error.toFixed(2)}%</strong></div>
                        <div>Difference: <strong>$${Math.abs(result.value - expected).toFixed(2)}</strong></div>
                    </div>
                </div>
            `;
        }

        function generateCode(bestFormula) {
            const codeMap = {
                'Old': `const calculateTargetProfit = (session) => {
  const { capital, totalTrades, accuracy, riskRewardRatio } = session;
  const winRate = accuracy / 100;
  const kelly = (winRate * riskRewardRatio - (1 - winRate)) / riskRewardRatio;

  if (kelly <= 0) return 0;

  const multiplier = accuracy * 0.06;
  const perTradeReturn = riskRewardRatio * accuracy * 0.001 * multiplier;
  const finalBalance = capital * Math.pow(1 + perTradeReturn, totalTrades);

  return finalBalance - capital;
};`,
                'New': `const calculateTargetProfit = (session) => {
  const { capital, totalTrades, accuracy, riskRewardRatio } = session;
  const winRate = accuracy / 100;
  const kelly = (winRate * riskRewardRatio - (1 - winRate)) / riskRewardRatio;

  if (kelly <= 0) return 0;

  const fractionalKelly = kelly * 0.25;
  const expectedValue = (winRate * riskRewardRatio) - (1 - winRate);
  const rrFactor = Math.pow(riskRewardRatio, 0.6);
  const accuracyFactor = Math.pow(winRate, 1.2);
  const perTradeReturn = fractionalKelly * expectedValue * rrFactor * accuracyFactor * 0.15;

  const finalBalance = capital * Math.pow(1 + perTradeReturn, totalTrades);
  return finalBalance - capital;
};`,
                'Hybrid': `const calculateTargetProfit = (session) => {
  const { capital, totalTrades, accuracy, riskRewardRatio } = session;
  const winRate = accuracy / 100;
  const kelly = (winRate * riskRewardRatio - (1 - winRate)) / riskRewardRatio;

  if (kelly <= 0) return 0;

  // Conditional logic based on RR ratio
  let scalingFactor, kellyFraction;

  if (riskRewardRatio <= 2) {
    kellyFraction = 0.20;
    scalingFactor = 0.12;
  } else if (riskRewardRatio <= 4) {
    kellyFraction = 0.25;
    scalingFactor = 0.18;
  } else {
    kellyFraction = 0.30;
    scalingFactor = 0.25;
  }

  const fractionalKelly = kelly * kellyFraction;
  const expectedValue = (winRate * riskRewardRatio) - (1 - winRate);
  const accuracyBoost = Math.pow(winRate, 1.1);
  const rrBoost = Math.pow(riskRewardRatio, 0.5);
  const perTradeReturn = fractionalKelly * expectedValue * accuracyBoost * rrBoost * scalingFactor;

  const finalBalance = capital * Math.pow(1 + perTradeReturn, totalTrades);
  return finalBalance - capital;
};`
            };

            document.getElementById('codeOutput').textContent = codeMap[bestFormula];
            document.getElementById('generatedCode').style.display = 'block';
        }
    </script>
</body>
</html>
